---
title: "Random effect models"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
library(tidyverse)
library(lubridate)
library(here)
library(patchwork)

theme_set(theme_bw())
theme_update(
  text = element_text(size = 16),
  plot.title = element_text(hjust = 0.5),
  plot.subtitle = element_text(hjust = 0.5)
)

data <- readRDS(here("Data", "construccion_clean.rds")) |> 
  mutate(year = year(fecha)) |> 
  filter(year <= 2020)

vl_data <- readRDS(here("Data", "vasquez_larre_data.rds")) |> 
  select(-ROA)
```

## Data partitioning

```{r}
set.seed(1234)
train_ids <- sample(nrow(vl_data), size = round(0.7 * nrow(vl_data)), replace = FALSE)
vl_train <- vl_data[train_ids, ]
vl_test <- vl_data[-train_ids, ]
```

# Modelo OLS

```{r}
ols <- lm(margen_bruto ~ ., data = vl_train |> select(-c(accion, fecha)))
summary(ols)
```

El modelo **OLS** ajustado a las variables de Vásquez y Larre encuentra efectos significativos para 7 de los 9 predictores, entre ellos $CT$ y $CT^2$. El coeficiente de determinación ajustado $R^2_{adj} = 0.4696$ indica que el ajuste es insuficiente para explicar la mitad de la variable respuesta, margen bruto.

El estadístico $F$ para la prueba de regresión es significativo, para niveles de significancia menores que 0.0000001.

## Análisis de residuales

### Normalidad

```{r}
ols_residuals <- residuals(ols) |> enframe(value = "residuals", name = NULL)
n_sturges <- nclass.Sturges(ols_residuals$residuals)

(
  resid_hist_ols <- ols_residuals |> 
    ggplot(aes(x = residuals)) +
    geom_histogram(
      aes(y = ..density.., fill = ..count..), 
      bins = n_sturges
    ) +
    stat_function(
      fun = dnorm, 
      color = "black",
      size = 1,
      args = list(mean = mean(ols_residuals$residuals),
                  sd = sd(ols_residuals$residuals))
    ) +
    scale_fill_gradient(low = "#dccccc", high = "#9c7c7c") +
    labs(title = "Histograma de residuales con curva normal teórica",
         x = "Residuales", y = "Densidad", fill = "Frecuencia") +
    theme(legend.position = c(0.8, 0.7))
)

(
  resid_qq_ols <- ols_residuals |> 
    ggplot(aes(sample = residuals)) +
    geom_qq(
      distribution = qnorm, 
            dparams = list(mean = mean(ols_residuals$residuals),
                           sd = sd(ols_residuals$residuals)),
      size = 2,
      color = "#9c7c7c"
      ) +
    geom_qq_line(
      distribution = qnorm, 
      dparams = list(mean = mean(ols_residuals$residuals),
                                sd = sd(ols_residuals$residuals)),
      size = 1,
      color = "black"
      ) +
    labs(title = "Gráfico Normal cuantil-cuantil",
         x = "Cuantiles teóricos", y = "Cuantiles muestreados")
)

resid_hist_ols + resid_qq_ols + plot_annotation(tag_levels = "a", tag_suffix = ")")
```



